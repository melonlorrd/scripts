#!/usr/bin/env bash
set -Eeuo pipefail

#######################################
# Defaults / Flags
#######################################
DO_RPM_OSTREE=false
DO_FLATPAK=false

#######################################
# Parse arguments
#######################################
if [[ "$#" -eq 0 ]]; then
  set -- --help
fi

for arg in "$@"; do
  case "$arg" in
    --all)
      DO_RPM_OSTREE=true
      DO_FLATPAK=true
      ;;
    --rpm-ostree)
      DO_RPM_OSTREE=true
      ;;
    --flatpak)
      DO_FLATPAK=true
      ;;
    -h|--help)
      cat <<EOF
Usage: $0 [OPTIONS]

Options:
  --all           Run all actions
  --rpm-ostree    Run hostname + rpm-ostree actions only
  --flatpak       Run Flatpak actions only
  -h, --help      Show this help message
EOF
      exit 0
      ;;
    *)
      echo "Unknown option: $arg" >&2
      exit 1
      ;;
  esac
done

#######################################
# Configuration
#######################################
HOSTNAME="luci"

RPM_OSTREE_PACKAGES=(
  micro
  gnome-tweaks
  adw-gtk3-theme
  stow
)

RPM_OSTREE_REMOVE=(
  firefox
  firefox-langpacks
  gnome-software
  gnome-software-rpm-ostree
)

FLATPAK_APPS=(
  org.gnome.Calendar
  org.gnome.Characters
  org.gnome.Loupe
  org.gnome.Papers
  org.gnome.TextEditor
  org.gnome.clocks
  org.gnome.World.Secrets
  org.gnome.Showtime
  org.gnome.Decibels
  com.mattjakeman.ExtensionManager
  app.zen_browser.zen
  dev.zed.Zed
  com.valvesoftware.Steam
  com.modrinth.ModrinthApp
  com.usebottles.bottles
  com.dec05eba.gpu_screen_recorder
  org.gtk.Gtk3theme.adw-gtk3
  org.gtk.Gtk3theme.adw-gtk3-dark
)

FLATHUB_REMOTE_NAME="flathub"
FLATHUB_REMOTE_URL="https://dl.flathub.org/repo/flathub.flatpakrepo"

#######################################
# Functions
#######################################
log() {
  echo "==> $*"
}

#######################################
# rpm-ostree actions
#######################################
if [[ "$DO_RPM_OSTREE" == true ]]; then
  log "Setting hostname to '${HOSTNAME}'"
  hostnamectl hostname "${HOSTNAME}"

  log "Canceling any pending rpm-ostree transaction"
  rpm-ostree cancel || true

  log "Upgrading base system"
  rpm-ostree upgrade

  log "Installing rpm-ostree packages"
  rpm-ostree install --idempotent "${RPM_OSTREE_PACKAGES[@]}"

  log "Removing unwanted rpm-ostree packages"
  rpm-ostree override remove "${RPM_OSTREE_REMOVE[@]}" || true
fi

#######################################
# Flatpak actions
#######################################
if [[ "$DO_FLATPAK" == true ]]; then
  log "Removing all existing Flatpak applications"
  flatpak remove --all --assumeyes || true

  log "Adding Flathub remote (if missing)"
  flatpak remote-add --if-not-exists \
    "${FLATHUB_REMOTE_NAME}" \
    "${FLATHUB_REMOTE_URL}"

  log "Ensuring Flathub remote is enabled"
  flatpak remote-modify "${FLATHUB_REMOTE_NAME}" --enable

  log "Installing Flatpak applications"
  flatpak install --assumeyes "${FLATHUB_REMOTE_NAME}" "${FLATPAK_APPS[@]}"
fi

log "Setup completed successfully"

